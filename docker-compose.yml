# Lexichord Development Services
# Usage: docker compose up -d
# Docs: https://docs.docker.com/compose/

services:
    # ============================================================================
    # PostgreSQL 16 Database with pgvector Extension
    # ============================================================================
    # LOGIC: We use pgvector/pgvector:pg16 for vector storage support (v0.4.1a).
    # This enables semantic search via high-dimensional vector embeddings.
    # Data is persisted to a named volume to survive container recreation.
    # The health check ensures dependent services wait for PostgreSQL to be ready
    # AND verifies the vector extension is available.
    # ============================================================================
    postgres:
        image: pgvector/pgvector:pg16
        container_name: lexichord-postgres
        restart: unless-stopped

        # Environment variables for database initialization
        environment:
            POSTGRES_USER: ${POSTGRES_USER:-lexichord}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-lexichord_dev}
            POSTGRES_DB: ${POSTGRES_DB:-lexichord}
            # Performance tuning for development
            POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"

        # Port mapping: host:container
        # LOGIC: Map to 5432 for standard tooling compatibility.
        # Change host port if you have a local PostgreSQL installation.
        ports:
            - "${POSTGRES_PORT:-5432}:5432"

        # Persistent data volume
        # LOGIC: Named volume ensures data survives container recreation.
        # Use 'docker compose down -v' to delete the volume and reset data.
        volumes:
            - lexichord-pgdata:/var/lib/postgresql/data
            # Optional: Mount initialization scripts
            - ./scripts/db-init:/docker-entrypoint-initdb.d:ro

        # Health check configuration
        # LOGIC: We verify both PostgreSQL readiness AND pgvector extension availability.
        # The vector extension check ensures semantic search features are usable.
        # Dependent services can use 'depends_on' with 'condition: service_healthy'.
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "pg_isready -U ${POSTGRES_USER:-lexichord} -d ${POSTGRES_DB:-lexichord} && psql -U ${POSTGRES_USER:-lexichord} -d ${POSTGRES_DB:-lexichord} -c \"SELECT 1 FROM pg_extension WHERE extname = 'vector';\" | grep -q 1",
                ]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s

        # Resource limits for development
        # LOGIC: Prevent runaway resource consumption on dev machines.
        deploy:
            resources:
                limits:
                    memory: 512M
                reservations:
                    memory: 256M

        # Logging configuration
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"

        # Network configuration
        networks:
            - lexichord-network

    # ============================================================================
    # Neo4j 5.x Graph Database (Knowledge Graph â€” CKVS Phase 1)
    # ============================================================================
    # LOGIC: Neo4j Community Edition provides the graph database for the Knowledge
    # Graph subsystem (v0.4.5e). Entities and relationships are stored as nodes
    # and edges, enabling efficient traversal and pattern matching for knowledge
    # validation. Data is persisted to named volumes to survive container recreation.
    # The health check ensures dependent services wait for Neo4j to be ready.
    # ============================================================================
    neo4j:
        image: neo4j:5.15-community
        container_name: lexichord-neo4j
        restart: unless-stopped

        # Environment variables for Neo4j configuration
        # LOGIC: NEO4J_AUTH sets initial credentials (username/password).
        # Memory settings are tuned for development workloads.
        # APOC plugin is included for advanced graph operations.
        environment:
            NEO4J_AUTH: ${NEO4J_AUTH:-neo4j/lexichord_dev_password}
            NEO4J_PLUGINS: '["apoc"]'
            NEO4J_dbms_memory_heap_initial__size: "256m"
            NEO4J_dbms_memory_heap_max__size: "512m"
            NEO4J_dbms_memory_pagecache_size: "128m"

        # Port mapping: host:container
        # LOGIC: 7474 = HTTP (Neo4j Browser UI), 7687 = Bolt (driver protocol).
        # Change host ports if you have a local Neo4j installation.
        ports:
            - "${NEO4J_HTTP_PORT:-7474}:7474"
            - "${NEO4J_BOLT_PORT:-7687}:7687"

        # Persistent data and log volumes
        # LOGIC: Named volumes ensure data survives container recreation.
        # Use 'docker compose down -v' to delete all volumes and reset data.
        volumes:
            - lexichord-neo4j-data:/data
            - lexichord-neo4j-logs:/logs

        # Health check configuration
        # LOGIC: Verifies Neo4j HTTP endpoint is responding.
        # This ensures the database is fully started before dependent services
        # attempt to connect via Bolt protocol.
        healthcheck:
            test: ["CMD", "wget", "-qO-", "http://localhost:7474"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 15s

        # Resource limits for development
        # LOGIC: Prevent runaway resource consumption on dev machines.
        # Neo4j requires more memory than PostgreSQL due to in-memory caching.
        deploy:
            resources:
                limits:
                    memory: 1G
                reservations:
                    memory: 512M

        # Logging configuration
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"

        # Network configuration
        networks:
            - lexichord-network

    # ============================================================================
    # pgAdmin 4 (Optional Database UI)
    # ============================================================================
    # LOGIC: Provides a web-based PostgreSQL administration interface.
    # Disabled by default; enable with: docker compose --profile tools up -d
    # ============================================================================
    pgadmin:
        image: dpage/pgadmin4:latest
        container_name: lexichord-pgadmin
        profiles:
            - tools
        restart: unless-stopped

        environment:
            PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@lexichord.local}
            PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
            PGADMIN_CONFIG_SERVER_MODE: "False"
            PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: "False"

        ports:
            - "${PGADMIN_PORT:-5050}:80"

        volumes:
            - lexichord-pgadmin:/var/lib/pgadmin

        depends_on:
            postgres:
                condition: service_healthy

        networks:
            - lexichord-network

# ============================================================================
# Named Volumes
# ============================================================================
volumes:
    lexichord-pgdata:
        name: lexichord-pgdata
    lexichord-pgadmin:
        name: lexichord-pgadmin
    lexichord-neo4j-data:
        name: lexichord-neo4j-data
    lexichord-neo4j-logs:
        name: lexichord-neo4j-logs

# ============================================================================
# Networks
# ============================================================================
networks:
    lexichord-network:
        name: lexichord-network
        driver: bridge
