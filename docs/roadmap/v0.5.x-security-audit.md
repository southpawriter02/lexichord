# Security Audit Report: v0.5.x Functionality

**Date:** October 26, 2023
**Target Version:** v0.5.x (The Retrieval)
**Auditor:** Cybersecurity/Blue Hat Expert

## 1. Executive Summary

This audit evaluates the security of the design and implementation specifications for Lexichord v0.5.x, focusing on Hybrid Search, Citations, and Context Expansion.

**Key Findings:**
*   **HIGH:** The designs for Context Expansion and Hybrid Search lack explicit access control mechanisms. In a multi-user ("Teams") environment, this creates a significant risk of lateral movement, where a user could potentially access content or context from documents they are not authorized to view.
*   **MEDIUM:** The `Citation` model exposes raw file system paths. In a client-server deployment, this constitutes Information Disclosure, revealing the server's directory structure to clients.
*   **LOW:** Resource consumption amplification in Hybrid Search (parallel queries) poses a minor Denial-of-Service (DoS) risk without proper rate limiting.

**Verified Controls:**
*   SQL Injection risks in `BM25SearchService` and `FilterQueryBuilder` were investigated and found to be effectively mitigated through the use of parameterized queries and proper input escaping.

## 2. Detailed Findings

### 2.1. High: Broken Access Control in Context Expansion

**Severity:** High (in Teams/Shared Environment)
**Component:** `IContextExpansionService` (v0.5.3)
**Impact:** Unauthorized access to sensitive document content (Lateral Movement).

**Analysis:**
The roadmap specifies "Sibling Chunk Retrieval" via SQL:
```sql
SELECT * FROM chunks
WHERE document_id = @docId
AND chunk_index BETWEEN @index - @before AND @index + @after
```
This query relies solely on `@docId` and `@index`. It implies that knowing a valid `DocumentId` (UUID) is sufficient to retrieve its content.
*   **Attack Vector:** If a user obtains a `DocumentId` (e.g., via a shared index, leakage in logs, or guessing), they can request context expansion for chunks in that document.
*   **Deficiency:** The design does not verify that the *current user* has read permissions for `@docId` before executing the expansion.

### 2.2. High: Data Isolation in Hybrid Search

**Severity:** High (in Teams/Shared Environment)
**Component:** `HybridSearchService` (v0.5.1)
**Impact:** Leakage of search results across user boundaries.

**Analysis:**
The `HybridSearchService` delegates to `IBM25SearchService` and `ISemanticSearchService`. Neither of these underlying services (as currently specified) enforces Row-Level Security (RLS) or mandatory user filtering.
*   **Vulnerability:** A user performing a search will query the *entire* index. If the database is shared (Teams tier), the result set will include matching chunks from *all* documents in the system, regardless of ownership.
*   **Mitigation Failure:** While `SearchOptions` includes a `DocumentFilter`, it is optional and client-provided. Security must be enforced by the service/database, not the client.

### 2.3. Medium: Information Disclosure via Citations

**Severity:** Medium
**Component:** `Citation` Model (v0.5.2)
**Impact:** Disclosure of server-side file structure.

**Analysis:**
The `Citation` record is defined as:
```csharp
public record Citation(Guid ChunkId, string DocumentPath, ...);
```
*   **Risk:** `DocumentPath` typically stores the absolute file system path (e.g., `/var/www/lexichord/user_data/docs/secret_project/specs.md`).
*   **Consequence:** Returning this path to the client reveals the directory layout of the host server. This information can aid attackers in planning further attacks (e.g., path traversal, locating sensitive config files).

### 2.4. Low: Resource Amplification (DoS)

**Severity:** Low
**Component:** `HybridSearchService` (v0.5.1c)
**Impact:** Database performance degradation / Denial of Service.

**Analysis:**
Hybrid search executes two heavy queries (Vector Search + Full-Text Search) in parallel for every user request.
*   `Task.WhenAll(semanticTask, bm25Task)` effectively doubles the query load (QPS) on the database compared to the v0.4.x baseline.
*   Without aggressive rate limiting or circuit breaking (e.g., via Polly), a surge in search traffic could easily saturate the database connection pool or CPU, rendering the service unavailable.

### 2.5. Security Verification: SQL Injection

**Status:** Verified Safe
**Components:** `FilterQueryBuilder`, `BM25SearchService`

**Analysis:**
Code review of the implemented components confirms robust defense against SQL Injection:
*   **`FilterQueryBuilder`:** Uses `Dictionary<string, object>` parameters for all dynamic values. Glob patterns are correctly escaped (SQL wildcards `%`, `_` are escaped) before being passed as parameters.
*   **`BM25SearchService`:** Uses `plainto_tsquery('english', @query)` which handles input sanitization natively in PostgreSQL.

## 3. Recommendations

### 3.1. Enforce Server-Side Authorization
1.  **Context Expansion:** Modify `IContextExpansionService` to accept `IUserContext`. Before expanding context, verify: `SELECT 1 FROM user_permissions WHERE user_id = @userId AND document_id = @docId`.
2.  **Search Services:** Inject a mandatory `OwnerId` or `TenantId` filter into all Search (Vector & BM25) queries within the repository layer. Do not rely on `SearchOptions.DocumentFilter` for security.

### 3.2. Sanitize Citation Paths
1.  **Relative Paths:** Only store and return paths relative to the workspace root (e.g., `docs/specs.md` instead of `/abs/path/to/docs/specs.md`).
2.  **Opaque IDs:** Consider returning only `DocumentId` and `Title` to the client. Let the client resolve the path locally if needed, or provide a separate `DownloadDocument(id)` endpoint that performs an authorization check.

### 3.3. Implement Resource Governance
1.  **Concurrency Limits:** Use a `Bulkhead` policy (Polly) to limit the maximum number of concurrent Hybrid Searches.
2.  **Degradation:** If the database load is high, automatically fall back to single-mode search (e.g., BM25 only) to shed load.

### 3.4. Stale Data Handling
1.  **Validation:** Ensure `ValidateCitationAsync` checks file access permissions, not just existence, to prevent "Oracle" attacks where a user probes for the existence of files they cannot read.
