# v0.6.8b — Integration Tests

## Scope

End-to-end integration tests for `CoPilotAgent` invocation pipelines, validating the full dependency chain: context assembly → prompt rendering → LLM invocation → citation extraction → usage metrics.

## New Files

### Test Infrastructure

| File                             | Description                                        |
| -------------------------------- | -------------------------------------------------- |
| `Fixtures/MockLLMServer.cs`      | Fluent mock `IChatCompletionService` configuration  |
| `Fixtures/IntegrationTestBase.cs`| Shared base class with pre-configured mocks (9 deps)|

### Test Classes

| File                                    | Tests | Coverage Area                       |
| --------------------------------------- | ----- | ----------------------------------- |
| `AgentWorkflowTests.cs`                 | 7     | End-to-end invocation workflows     |
| `StreamingIntegrationTests.cs`          | 5     | Streaming token relay + completion  |
| `ContextInjectionIntegrationTests.cs`   | 5     | RAG, style rules, citations         |
| `ErrorScenarioTests.cs`                 | 5     | Timeout, rate limit, auth, cancel   |

## Spec Deviations

| Area            | Spec                      | Actual                                     | Reason                                  |
| --------------- | ------------------------- | ------------------------------------------ | --------------------------------------- |
| Mock LLM Server | WireMock.Net HTTP server  | Moq-configured `IChatCompletionService`    | No HTTP layer — agent consumes service  |
| Timeout test    | TaskCanceledException wrap| HttpRequestException wrap                  | TCE inherits OperationCanceledException |

## Test Count Summary

| Class                                | Tests |
| ------------------------------------ | ----- |
| `AgentWorkflowTests`                 | 7     |
| `StreamingIntegrationTests`          | 5     |
| `ContextInjectionIntegrationTests`   | 5     |
| `ErrorScenarioTests`                 | 5     |
| **Total**                            | **22**|

## Verification

```bash
dotnet build tests/Lexichord.Tests.Unit/Lexichord.Tests.Unit.csproj
# Build succeeded. 0 Warning(s) 0 Error(s)

dotnet test tests/Lexichord.Tests.Unit --filter "FullyQualifiedName~Agents.Integration"
# Test Run Successful. Total tests: 22, Passed: 22, Failed: 0
```
