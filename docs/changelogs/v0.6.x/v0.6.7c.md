# v0.6.7c — Document-Aware Prompting

**Spec:** LCS-DES-v0.6.7c
**Module:** `Lexichord.Modules.Agents`
**Dependencies:** `Lexichord.Abstractions`, `Lexichord.Modules.Editor`, `Markdig 0.37.0`

## Summary

Adds Markdown AST-based document structure analysis to the Agents module, enabling the Co-pilot to understand *where* in a document the user is working. The analyzer parses documents via Markdig, caches the AST per document, and identifies content block types (code, table, list, prose, heading, blockquote, front matter), section headings, and local context around the cursor. A prompt selector maps detected structure to appropriate prompt templates.

Key capabilities:

- **AST Caching** — `ASTCacheProvider` maintains a `ConcurrentDictionary<string, MarkdownDocument>` cache with `GetOrParseAsync`, `GetCached`, `Invalidate`, and `ClearAll` operations
- **Content Type Detection** — Identifies `ContentBlockType` (9 values) by walking Markdig `Descendants()` and matching block types
- **Section Heading Discovery** — Finds the nearest `HeadingBlock` before the cursor position via recursive inline text extraction
- **Local Context Extraction** — Extracts a configurable window of text (default ±500 chars) around the cursor position
- **Agent Suggestion** — Recommends agents based on content type and section heading keywords (e.g., "code-helper" for code blocks)
- **Context-Aware Prompt Selection** — `ContextAwarePromptSelector` maps content types to template IDs and generates contextual prompt suggestions

## New Files

### Abstractions

- `Contracts/Editor/DocumentChangedEventArgs.cs` — EventArgs subclass with `string? DocumentPath` property for document change notifications

### Agents Module — Models

- `Models/ContentBlockType.cs` — Enum with 9 values: `Prose`, `CodeBlock`, `Table`, `List`, `Heading`, `Blockquote`, `FrontMatter`, `InlineCode`, `Link`
- `Models/DocumentContext.cs` — Record with `DocumentPath`, `CursorPosition`, `ContentType`, `CurrentSection`, `LocalContext`, `SuggestedAgentId`, `EditorContext`; includes `Empty` static property and `HasSection`/`HasSuggestedAgent` computed properties
- `Models/EditorContext.cs` — Record with `DocumentPath`, `CursorOffset`, `CurrentLine`, `CurrentColumn`, `SelectedText`, `DocumentLength`, `IsUntitled`; includes `HasSelection` computed property and `FromEditorService(IEditorService)` factory method
- `Models/PromptSuggestion.cs` — Record with `Label` and `TemplateId` properties for UI suggestion display

### Agents Module — Services

- `Services/IDocumentContextAnalyzer.cs` — Interface defining `AnalyzeAtPositionAsync`, `DetectContentType`, `GetCurrentSectionHeading`, `GetLocalContext`, `InvalidateCache`
- `Services/ASTCacheProvider.cs` — Internal class with `ConcurrentDictionary` cache, static `MarkdownPipeline` configured with `UseAdvancedExtensions()` + `UsePreciseSourceLocation()`, and `GetOrParseAsync`/`GetCached`/`Invalidate`/`ClearAll` methods
- `Services/DocumentContextAnalyzer.cs` — Internal class implementing `IDocumentContextAnalyzer` with `IEditorService`, `IAgentRegistry`, `ASTCacheProvider`, and `ILogger` dependencies; subscribes to `DocumentChanged` for cache invalidation; detects content types via AST block pattern matching; finds section headings via `HeadingBlock` traversal with recursive inline text extraction; extracts local context as ±500 char substring; suggests agents based on content type and heading keywords
- `Services/ContextAwarePromptSelector.cs` — Internal class with `IDocumentContextAnalyzer`, `IPromptTemplateRepository`, and `ILogger` dependencies; `SelectPromptAsync` maps content types to template IDs (`context-code-review`, `context-table-help`, `context-list-expand`, `context-general-improve`); `GetSuggestionsAsync` returns content-type-specific `PromptSuggestion` lists with optional section-based suggestion

### Tests

- `Modules/Agents/DocumentAwarePromptingTests.cs` — 16 tests across 3 classes

## Modified Files

- `Contracts/Editor/IEditorService.cs` — Added `CurrentDocumentPath`, `GetDocumentText()`, `CurrentLine`, `CurrentColumn`, `DocumentChanged` event in `#region v0.6.7c Document-Aware Prompting`
- `EditorService.cs` — Added v0.6.7c stub implementations delegating to `GetActiveDocument()` for `CurrentDocumentPath`, `GetDocumentText()`, `CurrentLine`, `CurrentColumn`; `DocumentChanged` event with `#pragma warning disable CS0067` stub
- `AgentsModule.cs` — Added DI registrations for `ASTCacheProvider` (singleton), `IDocumentContextAnalyzer`/`DocumentContextAnalyzer` (singleton), `ContextAwarePromptSelector` (singleton)
- `Lexichord.Modules.Agents.csproj` — Added `<PackageReference Include="Markdig" Version="0.37.0" />`

## Spec Deviations

| Spec                                                        | Implementation                              | Reason                                                            |
| ----------------------------------------------------------- | ------------------------------------------- | ----------------------------------------------------------------- |
| `DocumentChangedEventArgs` referenced but undefined in spec | Created in Abstractions                     | Event args class didn't exist in codebase                         |
| `IEditorService.CurrentDocumentPath`, `GetDocumentText()`, `CurrentLine`, `CurrentColumn` not in v0.6.7b interface | Added to `IEditorService` with stubs in `EditorService` | Members required by spec but not present in prior versions        |
| `block.Parent is FencedCodeBlock` pattern match in content type detection | Removed pattern match case                  | `MarkdownObject` does not expose a `Parent` property in Markdig 0.37.0 |
| `_license.HasFeature(LicenseFeature.CoPilotAgent)` | Not implemented (no license gating in v0.6.7c services) | Spec's `DocumentContextAnalyzer` and `ContextAwarePromptSelector` do not include license gating; consistent with pure analysis services |

## Tests: 16 planned (blocked by pre-existing AXAML build issue)

### DocumentContextAnalyzerTests (8 tests)

| # | Test                                                   | Verifies                                                |
|---|--------------------------------------------------------|---------------------------------------------------------|
| 1 | `AnalyzeAtPositionAsync_DetectsCorrectContentType` [Theory, 6 InlineData] | Content type detection for CodeBlock, Table, List, Prose, Heading, Blockquote |
| 2 | `AnalyzeAtPositionAsync_FindsSectionHeading`            | Section heading extraction ("Implementation", level 2)  |
| 3 | `AnalyzeAtPositionAsync_ExtractsLocalContext`           | Local context window (~1000 chars containing "CURSOR")  |
| 4 | `AnalyzeAtPositionAsync_SuggestsCodeHelperForCodeBlock` | Agent suggestion when "code-helper" is registered       |
| 5 | `AnalyzeAtPositionAsync_ReturnsNullAgent_WhenNotRegistered` | Null agent suggestion when no agents registered       |
| 6 | `AnalyzeAtPositionAsync_ReturnsEmpty_WhenFileMissing`   | `DocumentContext.Empty` for non-existent file path      |
| 7 | `AnalyzeAtPositionAsync_SetsDocumentPath`               | DocumentPath and CursorPosition propagation             |

### ASTCacheProviderTests (4 tests)

| # | Test                                          | Verifies                                      |
|---|-----------------------------------------------|-----------------------------------------------|
| 1 | `GetOrParseAsync_CachesResult`                | Same reference returned on second call        |
| 2 | `Invalidate_RemovesFromCache`                 | `GetCached` returns null after invalidation   |
| 3 | `GetOrParseAsync_ReturnsNull_WhenFileMissing` | Null for non-existent file                    |
| 4 | `ClearAll_RemovesAllEntries`                  | Both cached files null after `ClearAll`       |

### ContextAwarePromptSelectorTests (4 tests)

| # | Test                                                       | Verifies                                        |
|---|------------------------------------------------------------|-------------------------------------------------|
| 1 | `SelectPromptAsync_SelectsCodeReviewTemplate_ForCodeBlock` | "context-code-review" template for code blocks  |
| 2 | `SelectPromptAsync_SelectsGeneralTemplate_ForProse`        | "context-general-improve" template for prose     |
| 3 | `GetSuggestionsAsync_ReturnsCodSuggestions_ForCodeBlock`   | 3 code-specific suggestions for code blocks      |
| 4 | `GetSuggestionsAsync_IncludesSectionSuggestion_WhenInSection` | 4 suggestions (3 prose + 1 section-specific)  |
