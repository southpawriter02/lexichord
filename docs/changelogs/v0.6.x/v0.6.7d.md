# v0.6.7d — Quick Actions Panel

**Spec:** LCS-DES-v0.6.7d
**Module:** `Lexichord.Modules.Agents`
**Dependencies:** `Lexichord.Abstractions`, `Lexichord.Modules.Editor`, `MediatR`

## Summary

Adds a floating quick actions toolbar to the Agents module, providing one-click AI operations that appear near selected text. The panel integrates with the v0.6.7b inline suggestion preview system and v0.6.7c document context analysis to offer context-filtered actions (prose, code, table) with license tier gating.

Key capabilities:

- **Quick Action Registry** — `QuickActionsService` maintains a dictionary of built-in and custom actions with `RegisterAction`/`UnregisterAction` lifecycle management
- **Context-Aware Filtering** — Actions are filtered by `ContentBlockType` (via `IDocumentContextAnalyzer`), selection state, and `LicenseTier` (via `ILicenseContext.GetCurrentTier()`)
- **Two-Tier Template Resolution** — `ExecuteAsync` checks `IPromptTemplateRepository` first, then falls back to `BuiltInQuickActions.PromptTemplates` definitions
- **Agent Invocation** — Actions are executed through `IAgentRegistry.GetDefaultAgent()` (or a specific agent if configured), returning results via `QuickActionResult`
- **Event Publishing** — `QuickActionExecutedEvent` MediatR notification for telemetry, plus CLR `ActionExecuted` event for local ViewModel subscribers
- **Debounced Panel Display** — `QuickActionsPanelViewModel` subscribes to `IEditorService.SelectionChanged` with a 500ms debounce delay (per SBD success criteria)
- **Preview Integration** — Successful action results are shown via `IEditorInsertionService.ShowPreviewAsync` at the selection location

## New Files

### Agents Module — Models

- `Models/QuickAction.cs` — Record with 11 parameters (`ActionId`, `Name`, `Description`, `Icon`, `PromptTemplateId`, `AgentId?`, `KeyboardShortcut?`, `RequiresSelection`, `SupportedContentTypes?`, `MinimumLicenseTier`, `Order`); includes `AppliesToAllContentTypes` computed property and `AppliesTo(ContentBlockType)` method
- `Models/PromptTemplateDefinition.cs` — Lightweight record (`TemplateId`, `Name`, `SystemPrompt`, `UserPromptTemplate`) for built-in quick action prompt definitions
- `Models/QuickActionExecutedEvent.cs` — `QuickActionExecutedEvent` record implementing `MediatR.INotification` with telemetry fields (`ActionId`, `ActionName`, `InputCharacterCount`, `OutputCharacterCount`, `Duration`, `Success`, `AgentId?`); `QuickActionExecutedEventArgs` class with `required QuickAction Action` and `required QuickActionResult Result`

### Agents Module — Services

- `Services/IQuickActionsService.cs` — Interface defining `AllActions`, `GetAvailableActionsAsync`, `ExecuteAsync`, `RegisterAction`, `UnregisterAction`, `ShouldShowPanel`, `ActionExecuted` event; co-locates `QuickActionResult` record (`Success`, `Text`, `ErrorMessage?`, `Duration`)
- `Services/QuickActionsService.cs` — Implementation with 8 constructor dependencies (`IAgentRegistry`, `IPromptTemplateRepository`, `IPromptRenderer`, `IDocumentContextAnalyzer`, `IEditorService`, `ILicenseContext`, `IMediator`, `ILogger`); loads `BuiltInQuickActions.All` at construction; `GetAvailableActionsAsync` filters by content type + selection + license tier; `ExecuteAsync` does two-tier template lookup → prompt rendering → agent invocation → event publishing

### Agents Module — Static Definitions

- `BuiltInQuickActions.cs` — Static class with `All` property (8 actions: improve, simplify, expand, summarize, fix, explain-code, add-comments, add-row), `PromptTemplates` dictionary (8 `PromptTemplateDefinition` entries with system/user Mustache templates), and inner `QuickActionPromptTemplateAdapter` class implementing `IPromptTemplate`

### Agents Module — ViewModels

- `ViewModels/QuickActionItemViewModel.cs` — `ObservableObject` with `[ObservableProperty] bool _isExecuting`, `QuickAction Action` property, `[RelayCommand] ExecuteAsync()` delegating to parent callback with `IsExecuting` lifecycle management
- `ViewModels/QuickActionsPanelViewModel.cs` — `ObservableObject` with 5 dependencies (`IQuickActionsService`, `IEditorInsertionService`, `ISelectionContextService`, `IEditorService`, `ILogger`); `ShowAsync()` loads context-filtered actions; `Hide()` sets invisible; `ExecuteActionAsync(QuickAction)` retrieves selection → invokes service → shows preview; `OnSelectionChanged` with 500ms `Task.Delay` debounce and `CancellationTokenSource` cancellation; `UpdatePosition()` stub (awaiting editor coordinate API)

### Agents Module — Controls

- `Controls/QuickActionsPanel.axaml` — Avalonia `UserControl` with floating `Border`, `ItemsControl` bound to `Actions` collection, horizontal `StackPanel` layout, per-button `DataTemplate` showing action name and keyboard shortcut hint, drop shadow effect
- `Controls/QuickActionsPanel.axaml.cs` — Minimal code-behind with `InitializeComponent()`

### Tests

- `Modules/Agents/QuickActionsTests.cs` — 17 tests (15 planned + 2 from Theory expansion) across 3 classes

## Modified Files

- `AgentsModule.cs` — Added DI registrations for `IQuickActionsService`/`QuickActionsService` (singleton) and `QuickActionsPanelViewModel` (transient) after v0.6.7c block

## Spec Deviations

| Spec                                              | Implementation                                  | Reason                                                                |
| ------------------------------------------------- | ----------------------------------------------- | --------------------------------------------------------------------- |
| `_license.CurrentTier` property                   | `_license.GetCurrentTier()` method              | Project convention uses method, not property                          |
| `_editorService.GetSelectionBounds()`             | `UpdatePosition()` stub                         | Method does not exist on `IEditorService`; needs coordinate API       |
| `AgentResponse("text", 100, 50, ...)` in spec tests | `new AgentResponse("text", null, UsageMetrics.Zero)` | `AgentResponse` has `(Content, Citations?, Usage)` signature     |
| `options.Templates[id] = template` lookup         | Two-tier: repository → `BuiltInQuickActions.PromptTemplates` fallback | `PromptTemplateOptions` has no `Templates` dictionary |
| `OnSelectionChanged(object?, EventArgs)`          | `OnSelectionChanged(object?, SelectionChangedEventArgs)` | Actual event uses `SelectionChangedEventArgs`               |
| `Task.Delay(200)` debounce in spec                | `Task.Delay(500)` debounce                      | SBD success criteria specifies 500ms panel display delay              |
| Test namespace `*.Tests.Services`                 | `Lexichord.Modules.Agents.Tests`                | Matches established project convention                                |

## Tests: 17 total (15 planned + 2 Theory expansion)

### QuickActionsServiceTests (8 tests)

| # | Test                                               | Verifies                                                    |
|---|----------------------------------------------------|------------------------------------------------------------|
| 1 | `AllActions_ReturnsBuiltInActions`                  | ≥5 built-in actions including "improve" and "simplify"     |
| 2 | `GetAvailableActionsAsync_FiltersForProseSelection` | Prose filter excludes code-only and table-only actions      |
| 3 | `GetAvailableActionsAsync_FiltersForCodeBlock`      | Code block includes explain-code, add-comments              |
| 4 | `ExecuteAsync_CallsAgentWithRenderedPrompt`         | Full flow: template fallback → render → agent → MediatR    |
| 5 | `RegisterAction_AddsCustomAction`                   | Custom action appears in AllActions                         |
| 6 | `RegisterAction_ThrowsOnDuplicate`                  | Duplicate ID throws `InvalidOperationException`             |
| 7 | `UnregisterAction_RemovesAction`                    | Removed action no longer in AllActions                      |
| 8 | `ExecuteAsync_ThrowsArgumentException_WhenActionNotFound` | Unknown actionId throws `ArgumentException`           |

### QuickActionTests (5 tests — 3 Fact + 1 Theory with 3 InlineData)

| # | Test                                                | Verifies                                                    |
|---|-----------------------------------------------------|------------------------------------------------------------|
| 1 | `AppliesTo_ReturnsCorrectForProseAction` [Theory]   | Prose=true, CodeBlock=false, Table=false                   |
| 2 | `AppliesTo_ReturnsTrueWhenNoContentTypesSpecified`  | Universal action applies to all content types              |
| 3 | `AppliesToAllContentTypes_IsTrueWhenNull`            | Null SupportedContentTypes → true                          |

### QuickActionsPanelViewModelTests (4 tests)

| # | Test                                                | Verifies                                                    |
|---|-----------------------------------------------------|------------------------------------------------------------|
| 1 | `ShowAsync_WithNoSelection_DoesNotShow`             | No selection → IsVisible false, Actions empty              |
| 2 | `ShowAsync_WithSelection_PopulatesAndShows`         | Has selection → actions loaded, IsVisible true             |
| 3 | `Hide_SetsIsVisibleFalse`                           | Hide() sets IsVisible to false                             |
| 4 | `ExecuteByIndexAsync_OutOfRange_DoesNotThrow`       | Invalid index is safe no-op                                |
