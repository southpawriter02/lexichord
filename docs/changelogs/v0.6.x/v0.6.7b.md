# v0.6.7b — Inline Suggestions

**Spec:** LCS-DES-v0.6.7b  
**Module:** `Lexichord.Modules.Agents`  
**Dependencies:** `Lexichord.Abstractions`, `Lexichord.Modules.Editor`

## Summary

Enables AI-generated text to be previewed and inserted directly into the editor via a ghost overlay system. Supports two insertion modes:

- **Insert at Cursor** — Inserts AI text at the current caret position
- **Replace Selection** — Replaces selected text with AI-generated content

Both modes include a preview overlay for reviewing suggestions before acceptance, transaction-based undo grouping (single Ctrl+Z to revert), and WriterPro license gating.

## New Files

### Abstractions

- `Contracts/Editor/TextSpan.cs` — Record for representing text ranges with `Contains`, `OverlapsWith`, `FromStartEnd`
- `Contracts/Editor/PreviewStateChangedEventArgs.cs` — Event args for preview state changes
- `Contracts/Editor/IEditorInsertionService.cs` — Interface for insert/replace/preview operations

### Agents Module

- `Services/EditorInsertionService.cs` — Preview lifecycle, undo groups, UI thread dispatching
- `Commands/InsertAtCursorCommand.cs` — ICommand with WriterPro license gate and preview support
- `Commands/ReplaceSelectionCommand.cs` — ICommand with selection guard and WriterPro license gate
- `Controls/PreviewOverlayControl.axaml` — Ghost text overlay with Accept/Reject buttons
- `Controls/PreviewOverlayControl.axaml.cs` — Code-behind
- `ViewModels/PreviewOverlayViewModel.cs` — ViewModel with relay commands and state subscription

### Tests

- `Modules/Agents/InlineSuggestionsTests.cs` — 21 tests across 4 classes

## Modified Files

- `Contracts/Editor/IEditorService.cs` — Added `CaretOffset`, `InsertText`, `DeleteText`, `BeginUndoGroup`, `EndUndoGroup`, `ClearSelection`, `HasSelection`, `SelectionStart`, `SelectionLength`
- `AgentsModule.cs` — Added DI registrations for `IEditorInsertionService`, `InsertAtCursorCommand`, `ReplaceSelectionCommand`, `PreviewOverlayViewModel`
- `EditorService.cs` — Added v0.6.7b stub implementations delegating to active `IManuscriptViewModel`

## Spec Deviations

| Spec                                               | Implementation                              | Reason                                                       |
| -------------------------------------------------- | ------------------------------------------- | ------------------------------------------------------------ |
| `_license.HasFeature(LicenseFeature.CoPilotAgent)` | `GetCurrentTier() >= LicenseTier.WriterPro` | `LicenseFeature` enum doesn't exist; consistent with v0.6.7a |
| `Controls/` directory for UI                       | `Controls/` directory (matching spec)       | Spec uses `Controls/` instead of existing `Views/` pattern   |

## Tests: 21 planned (blocked by pre-existing AXAML build issue)
