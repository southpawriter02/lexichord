# v0.6.8a — Unit Test Suite

**Spec:** LCS-DES-v0.6.8a
**Module:** `Lexichord.Tests.Unit` (tests for `Lexichord.Modules.Agents`)
**Dependencies:** `Lexichord.Abstractions`, `Lexichord.Modules.Agents`, `xUnit`, `Moq`, `FluentAssertions`

## Summary

Adds a comprehensive unit test suite for the Agents module (v0.6.1–v0.6.7), covering SSE stream parsing, prompt template rendering, agent lifecycle, streaming handler state management, context injection orchestration, and usage tracking. All tests reside in the existing `Lexichord.Tests.Unit` project under `Modules/Agents/Unit/`.

Key contributions:

- **96 unit tests** across 8 test classes, all passing
- **4 shared test fixtures** providing reusable mock data, HTTP handlers, SSE stream builders, and prompt template factories
- **SSE Parser coverage** — Validates OpenAI (`data: {"choices":[...]}` + `[DONE]`) and Anthropic (`data: {"type":"content_block_delta",...}` + `message_stop`) formats including malformed JSON resilience, cancellation, and unsupported provider rejection
- **Agent lifecycle** — Tests `CoPilotAgent` invocation flow (context assembly, prompt rendering, LLM invocation, citation extraction, usage metrics) with graceful degradation and exception wrapping
- **Registry management** — Tests `AgentRegistry` discovery via real `ServiceCollection`/`ServiceProvider`, default agent fallback chain, custom agent registration with Teams license gating
- **Streaming handler** — Tests `StreamingChatHandler` state machine (Idle → Connecting → Streaming → Completed/Error) with synchronous `DispatchAction` override for deterministic testing
- **Context injection** — Tests `ContextInjector` provider orchestration, priority-based merge, disabled/unlicensed provider filtering, parallel execution, timeout resilience
- **Usage tracking** — Tests `UsageTracker` accumulation, session coordination, MediatR event publishing, license-gated monthly summary, and event publishing failure resilience
- **Template rendering** — Additional `MustachePromptRenderer` coverage for list iteration, nested sections, selection text patterns, special characters, and comment stripping

## New Files

### Test Fixtures

- `Modules/Agents/Unit/Fixtures/MockHttpMessageHandler.cs` — Reusable `HttpMessageHandler` subclass with `EnqueueResponse(HttpStatusCode, string)`, `EnqueueStreamingResponse(IEnumerable<string>)`, `EnqueueResponse(HttpResponseMessage)`, `ReceivedRequests` list, `RemainingResponses` count
- `Modules/Agents/Unit/Fixtures/TestChatResponses.cs` — Static factory class with `SimpleResponse()`, `EmptyResponse()`, `TruncatedResponse()`, `SimpleRequest()`, `RequestWithSystemPrompt()`, `SimpleAgentRequest()`, `FullContextAgentRequest()`, `SimpleAgentResponse()`, `SimpleUsageMetrics()`, `OpenAIJsonResponse`, `AnthropicJsonResponse` string properties
- `Modules/Agents/Unit/Fixtures/TestPromptTemplates.cs` — Static factory class with `CoPilotEditor()`, `WithRequiredVariables(params string[])`, `Minimal(string)`, `WithVariables(IReadOnlyList, IReadOnlyList)`, and constants `CoPilotEditorTemplateId`, `DefaultSystemPrompt`, `DefaultUserPrompt`
- `Modules/Agents/Unit/Fixtures/TestStreamingTokens.cs` — Static factory class with `CreateOpenAIStream(params string[])`, `CreateAnthropicStream(params string[])`, `OpenAIDataLine(string)`, `AnthropicDeltaLine(string)`, `AnthropicNonDeltaLine(string)`, `AnthropicDeltaWithoutTextLine()`, `CreateStreamFromString(string)`, `CreateEmptyStream()`, `ContentToken(string, int)`, `CompleteToken(int, string)`

### Test Classes

- `Modules/Agents/Unit/Streaming/OpenAISSEParserTests.cs` — 10 tests for `SSEParser` (OpenAI format): valid tokens, [DONE] marker, empty delta skip, empty choices skip, malformed JSON resilience, null stream guard, empty stream, non-data lines, blank lines, cancellation
- `Modules/Agents/Unit/Streaming/AnthropicSSEParserTests.cs` — 8 tests for `SSEParser` (Anthropic format): valid deltas, message_stop, non-delta event filtering, missing delta property, empty delta text, malformed JSON, sequential token indices, unsupported provider
- `Modules/Agents/Unit/Streaming/StreamingHandlerTests.cs` — 12 tests for `StreamingChatHandler`: Connecting state, placeholder message, IsStreaming flag, first token → Streaming transition, content accumulation, complete token ignored, Completed state, content finalization, IsStreaming false on complete, Error state, partial content preservation, HasError flag, ObjectDisposedException after dispose
- `Modules/Agents/Unit/Agents/CoPilotAgentTests.cs` — 17 tests for `CoPilotAgent`: AgentId, Name, Capabilities flags, happy path invocation, context injector call, prompt renderer call, batch mode for WriterPro, null request guard, empty message guard, context failure graceful degradation, cancellation propagation, exception wrapping in AgentInvocationException, no double-wrapping, citation extraction with search_hits, no citations without search_hits, usage metrics calculation, user_input context injection
- `Modules/Agents/Unit/Agents/AgentRegistryTests.cs` — 14 tests for `AgentRegistry`: GetAgent found/not-found, TryGetAgent valid/unknown/null, GetDefaultAgent with-setting/fallback/no-co-pilot/no-agents, AvailableAgents count, RegisterCustomAgent with-Teams/without-Teams, UnregisterCustomAgent existing/unknown
- `Modules/Agents/Unit/Agents/UsageTrackingTests.cs` — 12 tests for `UsageTracker`: single/multiple invocation accumulation, cross-conversation session totals, MediatR event publishing, event token count verification, mediator failure resilience, UsageRecorded event, StartConversation reset, ResetConversation clear, GetMonthlySummary license gate (non-Teams/Teams)
- `Modules/Agents/Unit/Templates/ContextInjectorTests.cs` — 12 tests for `ContextInjector`: no providers, single provider, priority merge, disabled provider, unlicensed provider, provider exception resilience, provider timeout, null request guard, parallel execution, all disabled, case-insensitive key merge
- `Modules/Agents/Unit/Templates/MustacheRendererTests.cs` — 12 tests for `MustachePromptRenderer`: list iteration, object list properties, nested sections (both truthy/falsy inner), selection text section present/absent, special characters preserved, Markdown preserved, performance (100 renders < 1s), comment stripping, RenderMessages produces System+User, ValidateVariables reports multiple missing

## Spec Deviations

| Spec                                     | Implementation                                      | Reason                                                                        |
| ---------------------------------------- | --------------------------------------------------- | ----------------------------------------------------------------------------- |
| Separate `Lexichord.Tests.Agents` project | Use existing `Lexichord.Tests.Unit` project         | Project already references Agents module; avoids project sprawl               |
| `ChatCompletionServiceTests`             | SSE parser tests split by provider format           | No separate OpenAI/Anthropic connector classes; SSEParser handles both        |
| `TokenCounterTests`                      | Not implemented                                     | No standalone token counter exists in current codebase                        |
| NSubstitute in spec examples             | Moq                                                 | Project convention uses Moq (matching all existing test files)                |
| ~45 unit tests (spec estimate)           | 96 tests                                            | More thorough coverage of actual implementations                             |
| `[Trait("Module", "Agents")]`            | `[Trait("SubPart", "v0.6.8a")]`                     | Project convention uses SubPart trait, not Module                             |

## Test Count Summary

| Test Class                | Tests |
| ------------------------- | :---: |
| OpenAISSEParserTests      |  10   |
| AnthropicSSEParserTests   |   8   |
| StreamingHandlerTests     |  12   |
| CoPilotAgentTests         |  17   |
| AgentRegistryTests        |  14   |
| UsageTrackingTests        |  12   |
| ContextInjectorTests      |  12   |
| MustacheRendererTests     |  12   |
| **Total**                 | **96** |

## Verification

```bash
# Build the test project
dotnet build tests/Lexichord.Tests.Unit

# Run only v0.6.8a tests
dotnet test tests/Lexichord.Tests.Unit --filter "SubPart=v0.6.8a"

# Run all Agents module unit tests
dotnet test tests/Lexichord.Tests.Unit --filter "Category=Unit"
```
