# v0.6.8d — Error Handling & Recovery

**Date:** 2026-02
**Status:** ✅ Complete
**Module:** `Lexichord.Modules.Agents`
**Spec:** `LCS-DES-068d`

---

## Summary

Error handling and recovery subsystem for the Agents module, adding a structured exception hierarchy, recovery strategy coordination, token budget management, rate limit queueing, and resilient chat service decoration with Polly v8 policies.

## Changes

### New Files

#### Production Code (`src/Lexichord.Modules.Agents/Resilience/`)

| File | Description |
| --- | --- |
| `RecoveryStrategy.cs` | Enum defining recovery strategies: Retry, Queue, Truncate, Fallback, None |
| `AgentException.cs` | Base exception with `UserMessage`, `IsRecoverable`, `Strategy`, and `TechnicalDetails` properties |
| `ProviderException.cs` | Provider-scoped exception base with `Provider` property |
| `AgentRateLimitException.cs` | Rate limit exception with `RetryAfter` and `QueuePosition`, maps to Queue strategy |
| `AgentAuthenticationException.cs` | Non-recoverable auth exception with None strategy |
| `ProviderUnavailableException.cs` | Provider outage with optional `EstimatedRecovery`, maps to Retry strategy |
| `InvalidResponseException.cs` | Malformed response exception, maps to Retry strategy |
| `TokenLimitException.cs` | Token budget exceeded with `RequestedTokens`/`MaxTokens`/`TruncatedTo`, maps to Truncate strategy |
| `ContextAssemblyException.cs` | Context pipeline failure, maps to Retry strategy |
| `AgentErrorEvent.cs` | MediatR notification record for telemetry (ErrorType, UserMessage, TechnicalDetails, WasRecovered, Timestamp) |
| `RateLimitStatusEventArgs.cs` | EventArgs record for UI status updates (IsRateLimited, EstimatedWait, QueueDepth) |
| `IErrorRecoveryService.cs` | Interface for exception → strategy mapping, recoverability checks, and user message generation |
| `IRateLimitQueue.cs` | Interface for rate-limited request queueing with StatusChanged event |
| `ITokenBudgetManager.cs` | Interface for token budget checking, estimation, and message truncation |
| `ErrorRecoveryService.cs` | Implementation mapping exceptions to strategies via type-based lookup, with user message generation |
| `TokenBudgetManager.cs` | Implementation using `ITokenCounter` for budget checking and truncation preserving system + newest messages |
| `RateLimitQueue.cs` | Implementation using `System.Threading.Channels` + `TaskCompletionSource` for background queue processing |

#### Production Code (`src/Lexichord.Modules.Agents/Chat/Services/`)

| File | Description |
| --- | --- |
| `ResilientChatService.cs` | `IChatCompletionService` decorator with Polly v8 resilience pipeline (Retry, Circuit Breaker, Timeout), rate limit queue integration, and MediatR error event publishing |

#### Test Code (`tests/Lexichord.Tests.Unit/Modules/Agents/Resilience/`)

| File | Description |
| --- | --- |
| `AgentExceptionTests.cs` | 40 tests covering exception hierarchy properties, strategies, recoverability, event records |
| `ErrorRecoveryServiceTests.cs` | 18 tests for strategy mapping, CanRecover logic, user messages, AttemptRecoveryAsync behavior |
| `TokenBudgetManagerTests.cs` | 14 tests for budget checking, estimation, truncation (system msg preservation, newest-first), edge cases |
| `RateLimitQueueTests.cs` | 12 tests for enqueue/process, cancellation, wait estimation, queue depth, StatusChanged events |
| `ResilientChatServiceTests.cs` | 18 tests for pass-through, rate limit queueing, cancellation, exception wrapping, event publishing |

### Modified Files

| File | Description |
| --- | --- |
| `AgentsModule.cs` | Added DI registrations for `IErrorRecoveryService`, `IRateLimitQueue`, `ITokenBudgetManager`, and `ResilientChatService` wrapping via factory |
| `Lexichord.Modules.Agents.csproj` | Added `Microsoft.Extensions.Resilience` NuGet package for Polly v8 |
| `docs/changelogs/CHANGELOG.md` | Added v0.6.8d changelog entry |

## DI Registration

| Interface | Implementation | Lifetime | Notes |
| --- | --- | --- | --- |
| `IErrorRecoveryService` | `ErrorRecoveryService` | Singleton | Stateless strategy mapper |
| `ITokenBudgetManager` | `TokenBudgetManager` | Singleton | Stateless, thread-safe token counting |
| `IRateLimitQueue` | `RateLimitQueue` | Singleton | Long-running background processing loop |
| `IChatCompletionService` | `ResilientChatService` | Singleton | Factory-resolved, wraps default provider from `ILLMProviderRegistry` |

## Exception Hierarchy

```
AgentException (base)
├── UserMessage: string
├── IsRecoverable: bool (default: true)
├── Strategy: RecoveryStrategy (default: Retry)
├── TechnicalDetails: string?
│
├── ProviderException
│   ├── Provider: string
│   │
│   ├── AgentRateLimitException → Queue strategy
│   ├── AgentAuthenticationException → None strategy (not recoverable)
│   ├── ProviderUnavailableException → Retry strategy
│   └── InvalidResponseException → Retry strategy
│
├── TokenLimitException → Truncate strategy
└── ContextAssemblyException → Retry strategy
```

## Recovery Strategies

| Strategy | Trigger | Handler |
| --- | --- | --- |
| Queue | Rate limit (429) | `RateLimitQueue` — background channel processing with `TaskCompletionSource` |
| Truncate | Token limit exceeded | `TokenBudgetManager` — preserves system messages + newest conversation |
| Retry | Provider unavailable, invalid response | Polly v8 exponential backoff (3 attempts, jitter) |
| None | Authentication failure | No automatic recovery, user action required |

## Spec Deviations

1. **`services.Decorate<>()` not used**: The keyed nature of `IChatCompletionService` registrations prevents using Scrutor's decorator pattern. Instead, `ResilientChatService` is registered via a factory delegate that resolves the default provider from `ILLMProviderRegistry`.

2. **Polly pipeline configured inline**: Rather than using `services.AddResiliencePipeline<>()` from `Microsoft.Extensions.Resilience`, the resilience pipeline is configured directly inside `ResilientChatService` to maintain encapsulation and simplify the decorator's DI surface.
