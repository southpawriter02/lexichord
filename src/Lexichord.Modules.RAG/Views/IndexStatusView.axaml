<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:Lexichord.Modules.RAG.ViewModels"
             xmlns:contracts="using:Lexichord.Abstractions.Contracts.RAG"
             mc:Ignorable="d"
             x:Class="Lexichord.Modules.RAG.Views.IndexStatusView"
             x:DataType="vm:IndexStatusViewModel">
    <!--
    ===========================================================================
    File: IndexStatusView.axaml
    Project: Lexichord.Modules.RAG
    Description: Settings page for viewing indexed document status.
    Version: v0.4.7a
    ===========================================================================
    LAYOUT:
         - Row 0: Statistics header with summary counts.
         - Row 1: Filter bar with text input and status dropdown.
         - Row 2: Scrollable document list with status badges.
    ===========================================================================
    DEPENDENCIES:
         - v0.4.7a: IndexStatusViewModel, IndexedDocumentViewModel
    ===========================================================================
    -->

    <UserControl.Styles>
        <!-- Statistics Card Style -->
        <Style Selector="Border.stat-card">
            <Setter Property="Background" Value="{DynamicResource SystemControlBackgroundChromeMediumBrush}" />
            <Setter Property="CornerRadius" Value="6" />
            <Setter Property="Padding" Value="12,8" />
            <Setter Property="MinWidth" Value="100" />
        </Style>

        <!-- Stat Value Style -->
        <Style Selector="TextBlock.stat-value">
            <Setter Property="FontSize" Value="24" />
            <Setter Property="FontWeight" Value="SemiBold" />
        </Style>

        <!-- Stat Label Style -->
        <Style Selector="TextBlock.stat-label">
            <Setter Property="FontSize" Value="11" />
            <Setter Property="Foreground" Value="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
        </Style>

        <!-- Document Item Style -->
        <Style Selector="Border.doc-item">
            <Setter Property="Background" Value="{DynamicResource SystemControlBackgroundAltHighBrush}" />
            <Setter Property="CornerRadius" Value="4" />
            <Setter Property="Padding" Value="12,8" />
            <Setter Property="Margin" Value="0,4" />
        </Style>
        <Style Selector="Border.doc-item:pointerover">
            <Setter Property="Background" Value="{DynamicResource SystemControlBackgroundListMediumBrush}" />
        </Style>

        <!-- Status Badge Base -->
        <Style Selector="Border.status-badge">
            <Setter Property="CornerRadius" Value="4" />
            <Setter Property="Padding" Value="6,2" />
        </Style>

        <!-- Status-specific colors -->
        <Style Selector="Border.status-indexed">
            <Setter Property="Background" Value="#2D7D32" />
        </Style>
        <Style Selector="Border.status-pending">
            <Setter Property="Background" Value="#F57C00" />
        </Style>
        <Style Selector="Border.status-indexing">
            <Setter Property="Background" Value="#1976D2" />
        </Style>
        <Style Selector="Border.status-stale">
            <Setter Property="Background" Value="#F9A825" />
        </Style>
        <Style Selector="Border.status-failed">
            <Setter Property="Background" Value="#C62828" />
        </Style>

        <!-- Empty State Style -->
        <Style Selector="Border.empty-state">
            <Setter Property="Padding" Value="40" />
            <Setter Property="Opacity" Value="0.6" />
        </Style>
    </UserControl.Styles>

    <Grid RowDefinitions="Auto,Auto,*">

        <!-- ===================================================================
        Row 0: Statistics Header
        =================================================================== -->
        <Border Grid.Row="0"
                Padding="16"
                Background="{DynamicResource SystemControlBackgroundChromeLowBrush}">
            <StackPanel Orientation="Horizontal"
                        Spacing="16"
                        HorizontalAlignment="Center">
                
                <!-- Document Count -->
                <Border Classes="stat-card">
                    <StackPanel>
                        <TextBlock Classes="stat-value"
                                   Text="{Binding Statistics.DocumentCount, FallbackValue=0}" />
                        <TextBlock Classes="stat-label"
                                   Text="Documents" />
                    </StackPanel>
                </Border>

                <!-- Chunk Count -->
                <Border Classes="stat-card">
                    <StackPanel>
                        <TextBlock Classes="stat-value"
                                   Text="{Binding Statistics.ChunkCount, FallbackValue=0}" />
                        <TextBlock Classes="stat-label"
                                   Text="Chunks" />
                    </StackPanel>
                </Border>

                <!-- Storage Size -->
                <Border Classes="stat-card">
                    <StackPanel>
                        <TextBlock Classes="stat-value"
                                   Text="{Binding Statistics.StorageSizeDisplay, FallbackValue='0 B'}" />
                        <TextBlock Classes="stat-label"
                                   Text="Storage" />
                    </StackPanel>
                </Border>

                <!-- Refresh Button -->
                <Button Command="{Binding RefreshCommand}"
                        VerticalAlignment="Center"
                        ToolTip.Tip="Refresh stale status">
                    <PathIcon Data="M12,4V2C6.48,2 2,6.48 2,12H4C4,7.58 7.58,4 12,4ZM12,20C7.58,20 4,16.42 4,12H2C2,17.52 6.48,22 12,22V20ZM20,12C20,16.42 16.42,20 12,20V22C17.52,22 22,17.52 22,12H20ZM12,4C16.42,4 20,7.58 20,12H22C22,6.48 17.52,2 12,2V4Z"
                             Width="16" Height="16" />
                </Button>
            </StackPanel>
        </Border>

        <!-- ===================================================================
        Row 1: Filter Bar
        =================================================================== -->
        <Border Grid.Row="1"
                Padding="16,12"
                BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
                BorderThickness="0,0,0,1">
            <Grid ColumnDefinitions="*,Auto">
                
                <!-- Text Filter -->
                <TextBox Grid.Column="0"
                         Text="{Binding FilterText, Mode=TwoWay}"
                         Watermark="Filter documents..."
                         Margin="0,0,12,0" />

                <!-- Status Filter -->
                <ComboBox Grid.Column="1"
                          Width="150"
                          SelectedIndex="0"
                          x:Name="StatusFilterComboBox">
                    <ComboBoxItem Content="All Statuses" Tag="{x:Null}" />
                    <ComboBoxItem Content="Indexed" Tag="{x:Static contracts:IndexingStatus.Indexed}" />
                    <ComboBoxItem Content="Pending" Tag="{x:Static contracts:IndexingStatus.Pending}" />
                    <ComboBoxItem Content="Indexing" Tag="{x:Static contracts:IndexingStatus.Indexing}" />
                    <ComboBoxItem Content="Stale" Tag="{x:Static contracts:IndexingStatus.Stale}" />
                    <ComboBoxItem Content="Failed" Tag="{x:Static contracts:IndexingStatus.Failed}" />
                </ComboBox>
            </Grid>
        </Border>

        <!-- ===================================================================
        Row 2: Document List
        =================================================================== -->
        <Grid Grid.Row="2">
            
            <!-- Loading Indicator -->
            <Border IsVisible="{Binding IsLoading}"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center">
                <StackPanel Spacing="8">
                    <ProgressBar IsIndeterminate="True"
                                 Width="200" />
                    <TextBlock Text="Loading documents..."
                               HorizontalAlignment="Center"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                </StackPanel>
            </Border>

            <!-- Empty State -->
            <Border Classes="empty-state"
                    IsVisible="{Binding !IsLoading}"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center">
                <Border.IsVisible>
                    <MultiBinding Converter="{x:Static BoolConverters.And}">
                        <Binding Path="!IsLoading" />
                        <Binding Path="FilteredDocuments.Count" Converter="{x:Static ObjectConverters.IsNull}" FallbackValue="True" />
                    </MultiBinding>
                </Border.IsVisible>
                <StackPanel Spacing="8">
                    <PathIcon Data="M14,2H6C4.89,2 4,2.89 4,4V20C4,21.1 4.89,22 6,22H18C19.1,22 20,21.1 20,20V8L14,2ZM18,20H6V4H13V9H18V20Z"
                              Width="48" Height="48"
                              Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                    <TextBlock Text="No documents indexed"
                               HorizontalAlignment="Center"
                               FontSize="14" />
                    <TextBlock Text="Documents will appear here once indexed"
                               HorizontalAlignment="Center"
                               FontSize="12"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                </StackPanel>
            </Border>

            <!-- Document List -->
            <ScrollViewer IsVisible="{Binding !IsLoading}"
                          Padding="16">
                <ItemsControl ItemsSource="{Binding FilteredDocuments}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="vm:IndexedDocumentViewModel">
                            <Border Classes="doc-item">
                                <Grid ColumnDefinitions="Auto,*,Auto,Auto">
                                    
                                    <!-- Document Icon -->
                                    <PathIcon Grid.Column="0"
                                              Data="M14,2H6C4.89,2 4,2.89 4,4V20C4,21.1 4.89,22 6,22H18C19.1,22 20,21.1 20,20V8L14,2ZM18,20H6V4H13V9H18V20Z"
                                              Width="24" Height="24"
                                              Margin="0,0,12,0"
                                              Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />

                                    <!-- Document Info -->
                                    <StackPanel Grid.Column="1"
                                                VerticalAlignment="Center">
                                        <TextBlock Text="{Binding FileName}"
                                                   FontWeight="SemiBold"
                                                   FontSize="13" />
                                        <TextBlock Text="{Binding FilePath}"
                                                   FontSize="11"
                                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                                   TextTrimming="CharacterEllipsis" />
                                        <StackPanel Orientation="Horizontal"
                                                    Spacing="12"
                                                    Margin="0,4,0,0">
                                            <TextBlock Text="{Binding ChunkCountDisplay}"
                                                       FontSize="11"
                                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                            <TextBlock Text="{Binding RelativeTime}"
                                                       FontSize="11"
                                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                        </StackPanel>
                                        <!-- Error Message -->
                                        <TextBlock Text="{Binding ErrorMessage}"
                                                   IsVisible="{Binding HasError}"
                                                   FontSize="11"
                                                   Foreground="#C42B1C"
                                                   Margin="0,4,0,0" />
                                    </StackPanel>

                                    <!-- Status Badge -->
                                    <Border Grid.Column="2"
                                            Classes="status-badge"
                                            Classes.status-indexed="{Binding Status, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static contracts:IndexingStatus.Indexed}}"
                                            Classes.status-pending="{Binding Status, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static contracts:IndexingStatus.Pending}}"
                                            Classes.status-indexing="{Binding Status, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static contracts:IndexingStatus.Indexing}}"
                                            Classes.status-stale="{Binding Status, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static contracts:IndexingStatus.Stale}}"
                                            Classes.status-failed="{Binding Status, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static contracts:IndexingStatus.Failed}}"
                                            VerticalAlignment="Center"
                                            Margin="12,0">
                                        <TextBlock Text="{Binding StatusDisplay}"
                                                   FontSize="11"
                                                   Foreground="White" />
                                    </Border>

                                    <!-- Action Buttons -->
                                    <StackPanel Grid.Column="3"
                                                Orientation="Horizontal"
                                                Spacing="4"
                                                VerticalAlignment="Center">
                                        <Button Command="{Binding ReindexCommand}"
                                                IsVisible="{Binding CanReindex}"
                                                ToolTip.Tip="Reindex this document"
                                                Padding="6,4">
                                            <PathIcon Data="M12,4V2C6.48,2 2,6.48 2,12H4C4,7.58 7.58,4 12,4Z"
                                                      Width="12" Height="12" />
                                        </Button>
                                        <Button Command="{Binding RetryCommand}"
                                                IsVisible="{Binding CanRetry}"
                                                ToolTip.Tip="Retry indexing"
                                                Padding="6,4">
                                            <PathIcon Data="M17.65,6.35C16.2,4.9 14.21,4 12,4C7.58,4 4,7.58 4,12C4,16.42 7.58,20 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18C8.69,18 6,15.31 6,12C6,8.69 8.69,6 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"
                                                      Width="12" Height="12" />
                                        </Button>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </Grid>
    </Grid>
</UserControl>
