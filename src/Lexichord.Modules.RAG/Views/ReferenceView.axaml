<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:Lexichord.Modules.RAG.ViewModels"
             xmlns:views="using:Lexichord.Modules.RAG.Views"
             xmlns:contracts="using:Lexichord.Abstractions.Contracts.RAG"
             mc:Ignorable="d" d:DesignWidth="320" d:DesignHeight="600"
             x:Class="Lexichord.Modules.RAG.Views.ReferenceView"
             x:DataType="vm:ReferenceViewModel">

    <!-- =============================================================================
    File: ReferenceView.axaml
    Project: Lexichord.Modules.RAG
    Description: Reference Panel UI for semantic search.
    ============================================================================= -->
    <!-- LOGIC: Three-row layout: Search Input, Results, Status Bar.
         - Row 0: Search box with autocomplete from history, search button, license warning.
         - Row 1: Virtualized results list with loading/no-results states.
         - Row 2: Status bar showing result count and search duration.
    -->
    <!-- DEPENDENCIES:
         - v0.4.6a: ReferenceViewModel, SearchResultItemViewModel
    -->

    <UserControl.Styles>
        <!-- Search Box Style -->
        <Style Selector="AutoCompleteBox">
            <Setter Property="Watermark" Value="Search documents..." />
        </Style>

        <!-- Result Item Container -->
        <Style Selector="Border.result-item">
            <Setter Property="Background" Value="{DynamicResource SystemControlBackgroundAltHighBrush}" />
            <Setter Property="CornerRadius" Value="4" />
            <Setter Property="Margin" Value="0,4,0,0" />
            <Setter Property="Padding" Value="12" />
        </Style>

        <Style Selector="Border.result-item:pointerover">
            <Setter Property="Background" Value="{DynamicResource SystemControlHighlightListLowBrush}" />
        </Style>

        <!-- Document Name Style -->
        <Style Selector="TextBlock.document-name">
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="FontSize" Value="13" />
        </Style>

        <!-- Section Heading Style -->
        <Style Selector="TextBlock.section-heading">
            <Setter Property="FontStyle" Value="Italic" />
            <Setter Property="Foreground" Value="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
            <Setter Property="FontSize" Value="11" />
        </Style>

        <!-- Preview Text Style -->
        <Style Selector="TextBlock.preview-text">
            <Setter Property="TextWrapping" Value="Wrap" />
            <Setter Property="FontSize" Value="12" />
            <Setter Property="Foreground" Value="{DynamicResource SystemControlForegroundBaseMediumHighBrush}" />
        </Style>

        <!-- Score Badge Style -->
        <Style Selector="Border.score-badge">
            <Setter Property="Background" Value="{DynamicResource SystemAccentColor}" />
            <Setter Property="CornerRadius" Value="10" />
            <Setter Property="Padding" Value="8,2" />
        </Style>

        <!-- License Warning Style -->
        <Style Selector="Border.license-warning">
            <Setter Property="Background" Value="#FFF4E4" />
            <Setter Property="CornerRadius" Value="4" />
            <Setter Property="Padding" Value="8" />
            <Setter Property="Margin" Value="0,8,0,0" />
        </Style>

        <!-- Error Message Style -->
        <Style Selector="Border.error-message">
            <Setter Property="Background" Value="#FDECEA" />
            <Setter Property="CornerRadius" Value="4" />
            <Setter Property="Padding" Value="8" />
            <Setter Property="Margin" Value="8" />
        </Style>

        <!-- No Results Style -->
        <Style Selector="Border.no-results">
            <Setter Property="Padding" Value="20" />
        </Style>
    </UserControl.Styles>

    <Grid RowDefinitions="Auto,*,Auto">

        <!-- ===================================================================
        Row 0: Search Input Section
        =================================================================== -->
        <Border Grid.Row="0"
                Padding="12"
                Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}">
            <StackPanel Spacing="8">

                <!-- Search Box with Mode Selector and Button -->
                <!-- v0.5.1d: Added search mode dropdown between search box and button -->
                <Grid ColumnDefinitions="*,Auto,Auto">

                    <!-- AutoComplete Search Box with History -->
                    <AutoCompleteBox Grid.Column="0"
                                   x:Name="SearchBox"
                                   Text="{Binding SearchQuery, Mode=TwoWay}"
                                   ItemsSource="{Binding SearchHistory}"
                                   FilterMode="Contains"
                                   IsEnabled="{Binding IsLicensed}"
                                   KeyDown="OnSearchKeyDown"
                                   MinimumPrefixLength="0"
                                   MaxDropDownHeight="200"
                                   ToolTip.Tip="Type to search indexed documents (Enter to search)"
                                   AutomationProperties.Name="Search documents">
                        <AutoCompleteBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding}"
                                         Padding="4,2"
                                         VerticalAlignment="Center" />
                            </DataTemplate>
                        </AutoCompleteBox.ItemTemplate>
                    </AutoCompleteBox>

                    <!-- v0.5.1d: Search Mode Dropdown -->
                    <ComboBox Grid.Column="1"
                              x:Name="SearchModeComboBox"
                              Margin="8,0,0,0"
                              Width="100"
                              SelectedItem="{Binding SelectedSearchMode}"
                              ItemsSource="{Binding AvailableSearchModes}"
                              IsEnabled="{Binding IsLicensed}"
                              ToolTip.Tip="Select search strategy"
                              AutomationProperties.Name="Search mode">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" Spacing="4">
                                    <TextBlock Text="{Binding}" VerticalAlignment="Center" />
                                    <!-- Lock icon for Hybrid when not licensed -->
                                    <PathIcon Data="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"
                                             Width="12" Height="12"
                                             Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                             IsVisible="False"
                                             x:Name="LockIcon" />
                                </StackPanel>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>

                    <!-- Search Button -->
                    <Button Grid.Column="2"
                          Margin="8,0,0,0"
                          Command="{Binding SearchCommand}"
                          ToolTip.Tip="Execute search"
                          AutomationProperties.Name="Search">
                        <PathIcon Data="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"
                                 Width="16" Height="16" />
                    </Button>
                </Grid>

                <!-- License Warning (shown when not licensed) -->
                <Border Classes="license-warning"
                      IsVisible="{Binding !IsLicensed}">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <PathIcon Data="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"
                                Width="16" Height="16" Foreground="#B25000" />
                        <TextBlock Text="Search requires a WriterPro license."
                                 Foreground="#B25000"
                                 VerticalAlignment="Center"
                                 FontSize="12" />
                    </StackPanel>
                </Border>

                <!-- v0.5.1d: Hybrid Lock Warning (shown when Hybrid is locked but user is licensed) -->
                <Border Classes="license-warning"
                      IsVisible="{Binding IsHybridLocked}">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <PathIcon Data="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"
                                Width="16" Height="16" Foreground="#B25000" />
                        <TextBlock Text="Hybrid search requires WriterPro. Semantic and Keyword modes available."
                                 Foreground="#B25000"
                                 VerticalAlignment="Center"
                                 TextWrapping="Wrap"
                                 FontSize="12" />
                    </StackPanel>
                </Border>

            </StackPanel>
        </Border>

        <!-- ===================================================================
        Row 1: Results Section
        =================================================================== -->
        <Grid Grid.Row="1">

            <!-- Loading Indicator -->
            <Border IsVisible="{Binding IsSearching}"
                  HorizontalAlignment="Center"
                  VerticalAlignment="Center">
                <StackPanel Spacing="12" HorizontalAlignment="Center">
                    <!-- Simple loading indicator -->
                    <Border Width="32" Height="32"
                           CornerRadius="16"
                           Background="{DynamicResource SystemAccentColor}"
                           Opacity="0.6"
                           HorizontalAlignment="Center">
                        <TextBlock Text="â—"
                                 FontSize="24"
                                 Foreground="White"
                                 HorizontalAlignment="Center"
                                 VerticalAlignment="Center" />
                    </Border>
                    <TextBlock Text="Searching..."
                             HorizontalAlignment="Center"
                             Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                </StackPanel>
            </Border>

            <!-- Error Message -->
            <Border Classes="error-message"
                  IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                  VerticalAlignment="Top">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <PathIcon Data="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"
                            Width="16" Height="16" Foreground="#C42B1C" />
                    <TextBlock Text="{Binding ErrorMessage}"
                             Foreground="#C42B1C"
                             TextWrapping="Wrap" />
                </StackPanel>
            </Border>

            <!-- No Results Message -->
            <Border Classes="no-results"
                  IsVisible="{Binding ShowNoResults}"
                  HorizontalAlignment="Center"
                  VerticalAlignment="Center">
                <StackPanel Spacing="8" HorizontalAlignment="Center">
                    <PathIcon Data="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"
                            Width="40" Height="40"
                            Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                    <TextBlock Text="No results found"
                             FontSize="14"
                             Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                    <TextBlock Text="Try adjusting your search terms"
                             FontSize="12"
                             Foreground="{DynamicResource SystemControlForegroundBaseMediumLowBrush}" />
                </StackPanel>
            </Border>

            <!-- Results List (Virtualized) -->
            <ScrollViewer IsVisible="{Binding HasResults}"
                        HorizontalScrollBarVisibility="Disabled"
                        VerticalScrollBarVisibility="Auto">
                <ItemsControl ItemsSource="{Binding Results}"
                            Margin="8,0,8,8">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <VirtualizingStackPanel />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <!-- v0.4.6b: Use dedicated SearchResultItemView for enhanced display -->
                        <DataTemplate DataType="vm:SearchResultItemViewModel">
                            <views:SearchResultItemView />
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>

        </Grid>

        <!-- ===================================================================
        Row 2: Status Bar
        =================================================================== -->
        <!-- v0.5.1d: Updated status bar to show search mode alongside result count and duration -->
        <Border Grid.Row="2"
              Padding="12,8"
              Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
              IsVisible="{Binding HasResults}">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <!-- Search Mode Indicator -->
                <TextBlock Grid.Column="0"
                         VerticalAlignment="Center"
                         FontSize="11"
                         Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}">
                    <TextBlock.Text>
                        <MultiBinding StringFormat="{}{0}">
                            <Binding Path="SelectedSearchMode" />
                        </MultiBinding>
                    </TextBlock.Text>
                </TextBlock>

                <!-- Result Count -->
                <TextBlock Grid.Column="1"
                         VerticalAlignment="Center"
                         HorizontalAlignment="Center"
                         FontSize="11"
                         Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}">
                    <TextBlock.Text>
                        <MultiBinding StringFormat="{}{0} result(s)">
                            <Binding Path="ResultCount" />
                        </MultiBinding>
                    </TextBlock.Text>
                </TextBlock>

                <!-- Duration -->
                <TextBlock Grid.Column="2"
                         VerticalAlignment="Center"
                         FontSize="11"
                         Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}">
                    <TextBlock.Text>
                        <MultiBinding StringFormat="{}{0:N0}ms">
                            <Binding Path="LastSearchDuration.TotalMilliseconds" />
                        </MultiBinding>
                    </TextBlock.Text>
                </TextBlock>
            </Grid>
        </Border>

    </Grid>
</UserControl>
