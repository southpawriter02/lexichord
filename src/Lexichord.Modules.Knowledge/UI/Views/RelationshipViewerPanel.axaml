<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:Lexichord.Modules.Knowledge.UI.ViewModels"
             xmlns:knowledge="using:Lexichord.Abstractions.Contracts.Knowledge"
             mc:Ignorable="d" d:DesignWidth="350" d:DesignHeight="400"
             x:Class="Lexichord.Modules.Knowledge.UI.Views.RelationshipViewerPanel"
             x:DataType="vm:RelationshipViewerPanelViewModel">
    <!-- =========================================================================
         RelationshipViewerPanel.axaml
         ==========================================================================
         LOGIC: Displays entity relationships in a hierarchical tree view with
           direction and type filtering. Part of the Entity Browser (v0.4.7h).
         ========================================================================= -->

    <UserControl.Styles>
        <!-- Style for group nodes (bold) -->
        <Style Selector="TreeViewItem TextBlock.node-label">
            <Setter Property="FontWeight" Value="Normal"/>
        </Style>
        <Style Selector="TreeViewItem TextBlock.group-label">
            <Setter Property="FontWeight" Value="SemiBold"/>
        </Style>
    </UserControl.Styles>

    <Grid RowDefinitions="Auto,Auto,*">
        <!-- Filter Controls -->
        <Border Grid.Row="0" 
                Padding="8"
                Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}">
            <Grid ColumnDefinitions="*,8,*">
                <!-- Direction Filter -->
                <StackPanel Grid.Column="0" Spacing="4">
                    <TextBlock Text="Direction" 
                               FontSize="11"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                    <ComboBox SelectedItem="{Binding DirectionFilter}"
                              HorizontalAlignment="Stretch">
                        <ComboBox.Items>
                            <knowledge:RelationshipDirection>Both</knowledge:RelationshipDirection>
                            <knowledge:RelationshipDirection>Incoming</knowledge:RelationshipDirection>
                            <knowledge:RelationshipDirection>Outgoing</knowledge:RelationshipDirection>
                        </ComboBox.Items>
                    </ComboBox>
                </StackPanel>

                <!-- Type Filter -->
                <StackPanel Grid.Column="2" Spacing="4">
                    <TextBlock Text="Type" 
                               FontSize="11"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                    <ComboBox ItemsSource="{Binding AvailableTypes}"
                              SelectedItem="{Binding TypeFilter}"
                              PlaceholderText="All types"
                              HorizontalAlignment="Stretch"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Status Bar -->
        <Border Grid.Row="1" 
                Padding="8,4"
                BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
                BorderThickness="0,0,0,1">
            <Grid ColumnDefinitions="*,Auto">
                <TextBlock Grid.Column="0"
                           FontSize="11"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}">
                    <Run Text="Showing"/>
                    <Run Text="{Binding FilteredCount, Mode=OneWay}" FontWeight="SemiBold"/>
                    <Run Text="of"/>
                    <Run Text="{Binding TotalCount, Mode=OneWay}" FontWeight="SemiBold"/>
                    <Run Text="relationships"/>
                </TextBlock>
                <Button Grid.Column="1" 
                        Content="Clear"
                        Command="{Binding ClearFiltersCommand}"
                        Padding="8,2"
                        FontSize="11"/>
            </Grid>
        </Border>

        <!-- Relationship Tree -->
        <Grid Grid.Row="2">
            <!-- Loading Overlay -->
            <Border Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                    IsVisible="{Binding IsLoading}"
                    ZIndex="10">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="8">
                    <ProgressBar IsIndeterminate="True" Width="150"/>
                    <TextBlock Text="Loading relationships..." 
                               HorizontalAlignment="Center"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                </StackPanel>
            </Border>

            <!-- Empty State -->
            <TextBlock Text="No relationships found"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                       IsVisible="{Binding !RootNodes.Count}"/>

            <!-- Tree View -->
            <TreeView ItemsSource="{Binding RootNodes}"
                      IsVisible="{Binding !!RootNodes.Count}"
                      Margin="4">
                <TreeView.ItemTemplate>
                    <TreeDataTemplate ItemsSource="{Binding Children}" 
                                      x:DataType="vm:RelationshipTreeNodeViewModel">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <!-- Node Label (group nodes are bold via IsGroup binding) -->
                            <TextBlock Text="{Binding Label}"
                                       Classes.group-label="{Binding IsGroup}"
                                       Classes.node-label="{Binding !IsGroup}"/>

                            <!-- Entity type badge for leaf nodes -->
                            <Border IsVisible="{Binding !IsGroup}"
                                    Background="{DynamicResource SystemControlBackgroundAccentBrush}"
                                    CornerRadius="3"
                                    Padding="4,1">
                                <TextBlock Text="{Binding EntityType}"
                                           FontSize="10"
                                           Foreground="{DynamicResource SystemControlForegroundAltHighBrush}"/>
                            </Border>
                        </StackPanel>
                    </TreeDataTemplate>
                </TreeView.ItemTemplate>
            </TreeView>
        </Grid>
    </Grid>
</UserControl>

