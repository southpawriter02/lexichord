<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:Lexichord.Modules.LLM.Presentation.ViewModels"
             xmlns:views="using:Lexichord.Modules.LLM.Presentation.Views"
             mc:Ignorable="d" d:DesignWidth="700" d:DesignHeight="600"
             x:Class="Lexichord.Modules.LLM.Presentation.Views.LLMSettingsView"
             x:DataType="vm:LLMSettingsViewModel">

    <!-- ═══════════════════════════════════════════════════════════════════════
         LLM SETTINGS VIEW
         Configuration page for LLM providers (API keys, default selection)
         Version: v0.6.1d
         ═══════════════════════════════════════════════════════════════════════ -->

    <UserControl.Styles>
        <!-- Provider list item styles -->
        <Style Selector="ListBoxItem">
            <Setter Property="Padding" Value="12,8" />
            <Setter Property="CornerRadius" Value="4" />
        </Style>

        <Style Selector="TextBlock.section-header">
            <Setter Property="FontSize" Value="16" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="Margin" Value="0,0,0,12" />
        </Style>

        <Style Selector="TextBlock.section-description">
            <Setter Property="Opacity" Value="0.7" />
            <Setter Property="TextWrapping" Value="Wrap" />
            <Setter Property="Margin" Value="0,0,0,16" />
        </Style>

        <Style Selector="TextBlock.field-label">
            <Setter Property="FontWeight" Value="Medium" />
            <Setter Property="Margin" Value="0,0,0,4" />
        </Style>

        <Style Selector="Border.card">
            <Setter Property="Background" Value="{DynamicResource CardBackgroundFillColorDefaultBrush}" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Padding" Value="16" />
        </Style>

        <!-- Default indicator star -->
        <Style Selector="TextBlock.default-star">
            <Setter Property="Text" Value="★" />
            <Setter Property="Foreground" Value="{DynamicResource AccentFillColorDefaultBrush}" />
            <Setter Property="FontSize" Value="14" />
            <Setter Property="Margin" Value="8,0,0,0" />
        </Style>

        <!-- Configured indicator -->
        <Style Selector="Ellipse.configured-dot">
            <Setter Property="Width" Value="8" />
            <Setter Property="Height" Value="8" />
            <Setter Property="Fill" Value="{DynamicResource StatusSuccessBrush}" />
            <Setter Property="Margin" Value="0,0,8,0" />
        </Style>

        <Style Selector="Ellipse.unconfigured-dot">
            <Setter Property="Width" Value="8" />
            <Setter Property="Height" Value="8" />
            <Setter Property="Fill" Value="{DynamicResource TextMutedBrush}" />
            <Setter Property="Margin" Value="0,0,8,0" />
        </Style>
    </UserControl.Styles>

    <Grid ColumnDefinitions="200,*" Margin="24">

        <!-- ═══════════════════════════════════════════════════════════════════
             LEFT PANEL: Provider List
             ═══════════════════════════════════════════════════════════════════ -->
        <Border Grid.Column="0" Classes="card" Margin="0,0,16,0">
            <DockPanel>
                <TextBlock DockPanel.Dock="Top"
                           Classes="section-header"
                           Text="Providers" />

                <ListBox ItemsSource="{Binding Providers}"
                         SelectedItem="{Binding SelectedProvider}"
                         Background="Transparent">
                    <ListBox.ItemTemplate>
                        <DataTemplate x:DataType="vm:ProviderConfigViewModel">
                            <StackPanel Orientation="Horizontal">
                                <!-- Configuration status dot -->
                                <Ellipse Classes.configured-dot="{Binding IsConfigured}"
                                         Classes.unconfigured-dot="{Binding !IsConfigured}"
                                         VerticalAlignment="Center" />

                                <!-- Provider name -->
                                <TextBlock Text="{Binding DisplayName}"
                                           VerticalAlignment="Center" />

                                <!-- Default indicator -->
                                <TextBlock Classes="default-star"
                                           IsVisible="{Binding IsDefault}"
                                           ToolTip.Tip="Default provider"
                                           VerticalAlignment="Center" />
                            </StackPanel>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </DockPanel>
        </Border>

        <!-- ═══════════════════════════════════════════════════════════════════
             RIGHT PANEL: Provider Configuration
             ═══════════════════════════════════════════════════════════════════ -->
        <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto">
            <StackPanel Spacing="24" IsVisible="{Binding SelectedProvider, Converter={x:Static ObjectConverters.IsNotNull}}">

                <!-- Provider Header -->
                <StackPanel>
                    <TextBlock Classes="section-header"
                               Text="{Binding SelectedProvider.DisplayName}" />
                    <TextBlock Classes="section-description"
                               Text="Configure API key and connection settings for this provider." />
                </StackPanel>

                <!-- License Gating Warning (Core tier) -->
                <Border CornerRadius="4"
                        Padding="12,8"
                        Background="#FFF3CD"
                        IsVisible="{Binding !CanConfigure}">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="⚠️" Width="16" />
                        <TextBlock Text="Upgrade to WriterPro or higher to configure LLM providers."
                                   Foreground="#856404"
                                   TextWrapping="Wrap"
                                   VerticalAlignment="Center" />
                    </StackPanel>
                </Border>

                <!-- API Key Section -->
                <Border Classes="card">
                    <StackPanel Spacing="16">
                        <TextBlock Text="API Key"
                                   FontWeight="SemiBold"
                                   FontSize="14" />

                        <!-- Current Key Display -->
                        <StackPanel Spacing="4">
                            <TextBlock Classes="field-label" Text="Current Key" />
                            <TextBlock Text="{Binding SelectedProvider.ApiKeyDisplay}"
                                       FontFamily="Consolas, Menlo, monospace"
                                       Opacity="0.7" />
                        </StackPanel>

                        <!-- New Key Input -->
                        <StackPanel Spacing="4">
                            <TextBlock Classes="field-label" Text="New API Key" />
                            <Grid ColumnDefinitions="*,Auto">
                                <TextBox Grid.Column="0"
                                         Text="{Binding SelectedProvider.ApiKeyInput}"
                                         Watermark="Enter API key..."
                                         PasswordChar="•"
                                         IsEnabled="{Binding CanConfigure}" />
                                <Button Grid.Column="1"
                                        Content="Save"
                                        Command="{Binding SaveApiKeyCommand}"
                                        Classes="accent"
                                        Margin="8,0,0,0"
                                        MinWidth="80" />
                            </Grid>
                        </StackPanel>

                        <!-- Delete Key Button -->
                        <Button Content="Delete API Key"
                                Command="{Binding DeleteApiKeyCommand}"
                                HorizontalAlignment="Left"
                                IsVisible="{Binding SelectedProvider.IsConfigured}" />
                    </StackPanel>
                </Border>

                <!-- Model Selection Section -->
                <Border Classes="card"
                        IsVisible="{Binding SelectedProvider.SupportedModels.Count}">
                    <StackPanel Spacing="12">
                        <TextBlock Text="Default Model"
                                   FontWeight="SemiBold"
                                   FontSize="14" />

                        <ComboBox ItemsSource="{Binding SelectedProvider.SupportedModels}"
                                  SelectedItem="{Binding SelectedProvider.SelectedModel}"
                                  MinWidth="200"
                                  IsEnabled="{Binding CanConfigure}" />
                    </StackPanel>
                </Border>

                <!-- Connection Test Section -->
                <Border Classes="card">
                    <StackPanel Spacing="16">
                        <TextBlock Text="Connection Test"
                                   FontWeight="SemiBold"
                                   FontSize="14" />

                        <StackPanel Orientation="Horizontal" Spacing="16">
                            <Button Content="Test Connection"
                                    Command="{Binding TestConnectionCommand}"
                                    MinWidth="120" />

                            <Button Content="Set as Default"
                                    Command="{Binding SetAsDefaultCommand}"
                                    MinWidth="120"
                                    IsVisible="{Binding SelectedProvider.IsConfigured}" />
                        </StackPanel>

                        <!-- Connection Status -->
                        <views:ConnectionStatusBadge
                            Status="{Binding SelectedProvider.Status}"
                            StatusMessage="{Binding SelectedProvider.StatusMessage}"
                            IsVisible="{Binding SelectedProvider.Status, Converter={x:Static ObjectConverters.IsNotNull}}" />
                    </StackPanel>
                </Border>

                <!-- Provider Info Section -->
                <Border Classes="card" Opacity="0.8">
                    <StackPanel Spacing="8">
                        <TextBlock Text="Provider Information"
                                   FontWeight="SemiBold"
                                   FontSize="14"
                                   Margin="0,0,0,8" />

                        <Grid ColumnDefinitions="120,*" RowDefinitions="Auto,Auto,Auto">
                            <TextBlock Grid.Row="0" Grid.Column="0"
                                       Text="Provider ID:"
                                       Opacity="0.6" />
                            <TextBlock Grid.Row="0" Grid.Column="1"
                                       Text="{Binding SelectedProvider.Name}"
                                       FontFamily="Consolas, Menlo, monospace" />

                            <TextBlock Grid.Row="1" Grid.Column="0"
                                       Text="Streaming:"
                                       Opacity="0.6" />
                            <TextBlock Grid.Row="1" Grid.Column="1"
                                       Text="{Binding SelectedProvider.SupportsStreaming}" />

                            <TextBlock Grid.Row="2" Grid.Column="0"
                                       Text="Models:"
                                       Opacity="0.6" />
                            <TextBlock Grid.Row="2" Grid.Column="1"
                                       Text="{Binding SelectedProvider.SupportedModels.Count}" />
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- Error Message -->
                <Border CornerRadius="4"
                        Padding="12,8"
                        Background="#F8D7DA"
                        IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                    <TextBlock Text="{Binding ErrorMessage}"
                               Foreground="#721C24"
                               TextWrapping="Wrap" />
                </Border>

            </StackPanel>
        </ScrollViewer>

        <!-- Empty State (no provider selected) -->
        <StackPanel Grid.Column="1"
                    VerticalAlignment="Center"
                    HorizontalAlignment="Center"
                    IsVisible="{Binding SelectedProvider, Converter={x:Static ObjectConverters.IsNull}}">
            <TextBlock Text="Select a provider to configure"
                       Opacity="0.5"
                       FontSize="14" />
        </StackPanel>

        <!-- Loading Overlay -->
        <Border Grid.Column="0" Grid.ColumnSpan="2"
                Background="#80000000"
                IsVisible="{Binding IsBusy}">
            <StackPanel VerticalAlignment="Center"
                        HorizontalAlignment="Center"
                        Spacing="12">
                <ProgressBar IsIndeterminate="True" Width="100" Height="4" />
                <TextBlock Text="Loading..."
                           Foreground="White"
                           HorizontalAlignment="Center" />
            </StackPanel>
        </Border>

    </Grid>
</UserControl>
